// Prisma schema for MedSpa EMR
// SQLite for local dev, Postgres-compatible schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ===========================================
// MULTI-TENANCY
// ===========================================

model Clinic {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  address   String?
  phone     String?
  email     String?
  timezone  String   @default("America/New_York")
  logoUrl   String?
  locationName String?
  externalId   String?
  addressLine2 String?
  city         String?
  state        String?
  zipCode      String?
  country      String   @default("US")
  tier         ClinicTier @default(Standard)
  website      String?
  locationHours    String?  // JSON: { mon: { enabled, start, end }, ... }
  socialAccounts   String?  // JSON: { yelp, facebook, instagram, ... }
  calendarSettings String?  // JSON: { timeInterval, startTime, endTime, colorUsage, firstDayOfWeek }
  defaultTaxRate   Float?   // Default tax rate percentage for invoices
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users             User[]
  patients          Patient[]
  services          Service[]
  appointments      Appointment[]
  encounters        Encounter[]
  charts            Chart[]
  photos            Photo[]
  consents          ConsentTemplate[]
  patientConsents   PatientConsent[]
  invoices          Invoice[]
  invoiceItems      InvoiceItem[]
  payments          Payment[]
  memberships          MembershipPlan[]
  patientMemberships   PatientMembership[]
  auditLogs         AuditLog[]
  rooms             Room[]
  resources         Resource[]
  chartTemplates    ChartTemplate[]
  products          Product[]
  communicationPreferences PatientCommunicationPreference[]
  conversations     Conversation[]
  messageTemplates  MessageTemplate[]
  notificationTemplates NotificationTemplate[]
  featureOverrides  ClinicFeatureOverride[]
  patientDocuments  PatientDocument[]
  migrationJobs     MigrationJob[]
  migrationRuns     MigrationRun[]
}

// ===========================================
// USERS & ROLES
// ===========================================

enum ClinicTier {
  Standard
  Pro
}

enum Role {
  Owner
  Admin
  Provider
  FrontDesk
  Billing
  MedicalDirector
  ReadOnly
}

model User {
  id            String    @id @default(cuid())
  clinicId      String
  email         String    @unique
  name          String
  passwordHash    String?
  emailVerified   DateTime?
  role            Role      @default(Provider)
  isActive        Boolean   @default(true)
  phone           String?
  alias           String?
  pronouns        String?
  profileImageUrl String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // MD Review supervision
  requiresMDReview  Boolean  @default(false)
  supervisingMDId   String?
  supervisingMD     User?    @relation("Supervision", fields: [supervisingMDId], references: [id])
  supervisedUsers   User[]   @relation("Supervision")

  // Relations
  clinic               Clinic              @relation(fields: [clinicId], references: [id])
  appointments         Appointment[]       @relation("AppointmentProvider")
  encounters           Encounter[]         @relation("EncounterProvider")
  charts               Chart[]             @relation("ChartCreator")
  signedCharts         Chart[]             @relation("ChartSigner")
  providerSignedCharts Chart[]             @relation("ChartProviderSigner")
  auditLogs            AuditLog[]
  photosTaken          Photo[]
  uploadedDocuments    PatientDocument[]

  @@index([clinicId])
  @@index([email])
}

// ===========================================
// PATIENTS & CRM
// ===========================================

model Patient {
  id            String    @id @default(cuid())
  clinicId      String
  firstName     String
  lastName      String
  email         String?
  phone         String?
  dateOfBirth   DateTime?
  gender        String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  allergies     String?   // Stored as text, can be JSON in practice
  medicalNotes  String?
  tags          String?   // Comma-separated or JSON array
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  // Relations
  clinic           Clinic            @relation(fields: [clinicId], references: [id])
  appointments     Appointment[]
  encounters       Encounter[]
  charts           Chart[]
  photos           Photo[]
  consents         PatientConsent[]
  invoices         Invoice[]
  patientMemberships PatientMembership[]
  communicationPreference PatientCommunicationPreference?
  documents        PatientDocument[]
  conversation     Conversation?
  messages         Message[]

  @@index([clinicId])
  @@index([lastName, firstName])
  @@index([email])
  @@index([phone])
}

// ===========================================
// SCHEDULING
// ===========================================

model Room {
  id            String   @id @default(cuid())
  clinicId      String
  name          String
  description   String?
  category      String?
  color         String?
  capacity      String   @default("one")
  maxConcurrent Int      @default(1)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  clinic       Clinic        @relation(fields: [clinicId], references: [id])
  appointments Appointment[]

  @@index([clinicId])
}

model Resource {
  id            String   @id @default(cuid())
  clinicId      String
  name          String
  description   String?
  category      String?
  color         String?
  capacity      String   @default("one")
  maxConcurrent Int      @default(1)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  clinic       Clinic        @relation(fields: [clinicId], references: [id])
  appointments Appointment[]

  @@index([clinicId])
}

enum AppointmentStatus {
  Scheduled
  Confirmed
  CheckedIn
  InProgress
  Completed
  NoShow
  Cancelled
}

model Appointment {
  id          String            @id @default(cuid())
  clinicId    String
  patientId   String
  providerId  String
  serviceId   String?
  roomId      String?
  resourceId  String?
  startTime   DateTime
  endTime     DateTime
  status      AppointmentStatus @default(Scheduled)
  notes       String?
  checkedInAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  checkedOutAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?         // Soft delete

  // Relations
  clinic   Clinic   @relation(fields: [clinicId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])
  provider User     @relation("AppointmentProvider", fields: [providerId], references: [id])
  service  Service? @relation(fields: [serviceId], references: [id])
  room     Room?     @relation(fields: [roomId], references: [id])
  resource Resource? @relation(fields: [resourceId], references: [id])
  chart     Chart?
  encounter Encounter?
  invoice   Invoice?

  @@index([clinicId])
  @@index([patientId])
  @@index([providerId])
  @@index([startTime])
}

// ===========================================
// SERVICES
// ===========================================

model Service {
  id          String   @id @default(cuid())
  clinicId    String
  name        String
  description String?
  duration    Int      @default(30) // in minutes
  price       Float    @default(0)
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  clinic              Clinic                  @relation(fields: [clinicId], references: [id])
  appointments        Appointment[]
  invoiceItems        InvoiceItem[]
  serviceTemplates    ServiceTemplate[]

  @@index([clinicId])
}

model ServiceTemplate {
  id         String @id @default(cuid())
  serviceId  String
  templateId String

  service  Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  template ChartTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([serviceId, templateId])
  @@index([serviceId])
  @@index([templateId])
}

model Product {
  id             String   @id @default(cuid())
  clinicId       String
  name           String
  description    String?
  size           String?
  sku            String?
  upc            String?
  category       String?
  retailPrice    Float    @default(0)
  wholesaleCost  Float    @default(0)
  vendor         String?
  inventoryCount Int      @default(0)
  taxable        Boolean  @default(true)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  clinic       Clinic        @relation(fields: [clinicId], references: [id])
  invoiceItems InvoiceItem[]

  @@index([clinicId])
}

// ===========================================
// CLINICAL ENCOUNTERS & CHARTING
// ===========================================

enum EncounterStatus {
  Draft
  PendingReview
  Finalized
}

enum ChartStatus {
  Draft
  NeedsSignOff
  MDSigned
}

model Encounter {
  id                  String          @id @default(cuid())
  appointmentId       String          @unique
  clinicId            String
  patientId           String
  providerId          String
  status              EncounterStatus @default(Draft)
  requiresSupervision Boolean         @default(false)
  startedAt           DateTime        @default(now())
  finalizedAt         DateTime?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id])
  clinic      Clinic      @relation(fields: [clinicId], references: [id])
  patient     Patient     @relation(fields: [patientId], references: [id])
  provider    User        @relation("EncounterProvider", fields: [providerId], references: [id])
  chart       Chart?
  addenda     Addendum[]

  @@index([clinicId])
  @@index([patientId])
  @@index([providerId])
  @@index([status])
}

model Addendum {
  id          String   @id @default(cuid())
  clinicId    String
  encounterId String
  authorId    String
  text        String
  createdAt   DateTime @default(now())

  encounter Encounter @relation(fields: [encounterId], references: [id])

  @@index([encounterId])
  @@index([clinicId])
}

enum TreatmentCardType {
  Injectable
  Laser
  Esthetics
  Other
}

model ChartTemplate {
  id           String   @id @default(cuid())
  clinicId     String
  type         String   @default("chart") // "chart" or "form"
  name         String
  description  String?
  category     String?
  fieldsConfig String   // JSON array of field definitions
  status       String   @default("Active") // Active, Draft, Archived
  isSystem     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  clinic           Clinic            @relation(fields: [clinicId], references: [id])
  charts           Chart[]
  serviceTemplates ServiceTemplate[]
  @@index([clinicId])
}

model Chart {
  id              String      @id @default(cuid())
  clinicId        String
  patientId       String?
  appointmentId   String?     @unique
  encounterId     String?     @unique
  templateId      String?
  createdById     String?
  status          ChartStatus @default(Draft)

  // Treatment details
  chiefComplaint  String?
  areasTreated   String?     // JSON array of areas
  productsUsed    String?     // JSON array of products with lot/expiration
  dosageUnits     String?
  technique       String?
  aftercareNotes  String?
  additionalNotes String?

  // Provider signature (for supervised providers)
  providerSignedAt    DateTime?
  providerSignedById  String?
  providerSignedBy    User?    @relation("ChartProviderSigner", fields: [providerSignedById], references: [id])

  // Medical Director sign-off metadata
  signedById      String?
  signedByName    String?
  signedAt        DateTime?
  recordHash      String?     // Immutable hash for integrity verification

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft delete

  // Relations
  clinic      Clinic         @relation(fields: [clinicId], references: [id])
  patient     Patient?       @relation(fields: [patientId], references: [id])
  appointment Appointment?   @relation(fields: [appointmentId], references: [id])
  encounter   Encounter?     @relation(fields: [encounterId], references: [id])
  template    ChartTemplate? @relation(fields: [templateId], references: [id])
  createdBy   User?          @relation("ChartCreator", fields: [createdById], references: [id])
  signedBy    User?          @relation("ChartSigner", fields: [signedById], references: [id])
  photos      Photo[]
  treatmentCards TreatmentCard[]

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
  @@index([createdById])
}

model TreatmentCard {
  id             String            @id @default(cuid())
  chartId        String
  templateType   TreatmentCardType @default(Other)
  title          String
  narrativeText  String            @default("")
  structuredData String            @default("{}") // JSON string
  sortOrder      Int               @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  chart          Chart          @relation(fields: [chartId], references: [id])
  photos         Photo[]
  aiDraftEvents  AiDraftEvent[]

  @@index([chartId])
}

model AiDraftEvent {
  id                 String    @id @default(cuid())
  clinicId           String
  treatmentCardId    String
  kind               String    @default("TYPED")
  inputSummaryText   String    @default("")
  audioUrl           String?
  transcriptText     String?
  modelInfo          String    @default("{}")
  structuredPatch    String    @default("{}")
  narrativeDraftText String    @default("")
  missingHighRisk    String    @default("[]")
  conflicts          String    @default("[]")
  warnings           String    @default("[]")
  appliedAt          DateTime?
  createdById        String
  createdAt          DateTime  @default(now())

  treatmentCard TreatmentCard @relation(fields: [treatmentCardId], references: [id])

  @@index([treatmentCardId])
  @@index([clinicId])
}

// ===========================================
// CLINICAL PHOTOS
// ===========================================

model Photo {
  id              String   @id @default(cuid())
  clinicId        String
  patientId       String
  chartId         String?
  treatmentCardId String?
  takenById       String
  filename        String
  storagePath     String   // Path in storage system
  mimeType        String
  sizeBytes       Int
  category        String?  // before, after, progress, etc.
  annotations     String?  // JSON: vector overlays, points, lines
  caption         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime? // Soft delete

  // Relations
  clinic        Clinic         @relation(fields: [clinicId], references: [id])
  patient       Patient        @relation(fields: [patientId], references: [id])
  chart         Chart?         @relation(fields: [chartId], references: [id])
  treatmentCard TreatmentCard? @relation(fields: [treatmentCardId], references: [id])
  takenBy       User           @relation(fields: [takenById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([chartId])
  @@index([treatmentCardId])
}

// ===========================================
// CONSENTS
// ===========================================

model ConsentTemplate {
  id        String    @id @default(cuid())
  clinicId  String
  name      String
  content   String    // HTML or Markdown content
  version   String    @default("1.0")
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  clinic          Clinic           @relation(fields: [clinicId], references: [id])
  patientConsents PatientConsent[]

  @@index([clinicId])
}

model PatientConsent {
  id                String    @id @default(cuid())
  clinicId          String
  patientId         String
  templateId        String
  signatureData     String?   // Base64 or JSON signature data
  signedAt          DateTime?
  ipAddress         String?
  userAgent         String?
  templateSnapshot  String?   // Snapshot of template content at signing time
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? // Soft delete

  // Relations
  clinic   Clinic          @relation(fields: [clinicId], references: [id])
  patient  Patient         @relation(fields: [patientId], references: [id])
  template ConsentTemplate @relation(fields: [templateId], references: [id])

  @@index([clinicId])
  @@index([patientId])
}

// ===========================================
// PATIENT DOCUMENTS
// ===========================================

model PatientDocument {
  id            String    @id @default(cuid())
  clinicId      String
  patientId     String
  uploadedById  String
  filename      String
  storagePath   String
  mimeType      String?
  sizeBytes     Int       @default(0)
  category      String?   // "lab", "consent_scan", "imported", etc.
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  clinic     Clinic  @relation(fields: [clinicId], references: [id])
  patient    Patient @relation(fields: [patientId], references: [id])
  uploadedBy User    @relation(fields: [uploadedById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([createdAt])
}

// ===========================================
// BILLING
// ===========================================

enum InvoiceStatus {
  Draft
  Sent
  PartiallyPaid
  Paid
  Void
  Refunded
}

model Invoice {
  id            String        @id @default(cuid())
  clinicId      String
  patientId     String
  appointmentId String?       @unique
  invoiceNumber String
  status        InvoiceStatus @default(Draft)
  subtotal      Float         @default(0)
  discountAmount Float        @default(0)
  discountPercent Float?
  taxAmount     Float         @default(0)
  taxRate       Float?
  total         Float         @default(0)
  notes         String?
  dueDate       DateTime?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  // Relations
  clinic      Clinic       @relation(fields: [clinicId], references: [id])
  patient     Patient      @relation(fields: [patientId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  items       InvoiceItem[]
  payments    Payment[]

  @@unique([clinicId, invoiceNumber])
  @@index([clinicId])
  @@index([patientId])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  clinicId    String
  invoiceId   String
  serviceId   String?
  productId   String?
  description String
  quantity    Int     @default(1)
  unitPrice   Float
  total       Float
  deletedAt   DateTime?

  // Relations
  clinic  Clinic   @relation(fields: [clinicId], references: [id])
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id])
  product Product? @relation(fields: [productId], references: [id])

  @@index([clinicId])
  @@index([invoiceId])
}

model Payment {
  id            String   @id @default(cuid())
  clinicId      String
  invoiceId     String
  amount        Float
  paymentMethod String   // cash, credit, debit, etc.
  reference     String?  // External reference number
  notes         String?
  createdAt     DateTime @default(now())
  deletedAt     DateTime?

  // Relations
  clinic  Clinic  @relation(fields: [clinicId], references: [id])
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([invoiceId])
}

// ===========================================
// MEMBERSHIPS & PACKAGES
// ===========================================

model MembershipPlan {
  id            String   @id @default(cuid())
  clinicId      String
  name          String
  description   String?
  price         Float    // Dollar amount charged per cycle
  billingCycle  String   @default("Monthly") // Always Monthly
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  clinic             Clinic                  @relation(fields: [clinicId], references: [id])
  patientMemberships PatientMembership[]

  @@index([clinicId])
}


model PatientMembership {
  id        String   @id @default(cuid())
  clinicId  String
  patientId String
  planId    String
  status    String   @default("Active") // Active, Paused, Cancelled
  startDate DateTime @default(now())
  termMonths   Int      @default(12)
  nextBillDate DateTime?
  cancelledAt  DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clinic  Clinic         @relation(fields: [clinicId], references: [id])
  patient Patient        @relation(fields: [patientId], references: [id])
  plan    MembershipPlan @relation(fields: [planId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
}

// ===========================================
// AUDIT LOGGING
// ===========================================

enum AuditAction {
  ChartView
  ChartCreate
  ChartUpdate
  ChartSign
  PhotoView
  PhotoUpload
  PhotoAnnotationUpdate
  PhotoDelete
  ConsentView
  ConsentSign
  PatientView
  PatientCreate
  PatientUpdate
  InvoiceView
  InvoiceCreate
  InvoiceUpdate
  InvoiceDelete
  PaymentCreate
  Login
  Logout
  AppointmentConfirm
  AppointmentCheckIn
  AppointmentStart
  AppointmentComplete
  AppointmentCheckOut
  AppointmentUndoCheckIn
  AppointmentUndoStart
  AppointmentUndoComplete
  MessageSend
  MessageFailed
  ConversationView
  AiChat
  AiDraftCreated
  AiDraftApplied
  VoiceDraftRecorded
  TranscriptCreated
  BeginService
  EncounterCreate
  EncounterUpdate
  ChartProviderSign
  MDCoSign
  ExportPdf
  AddendumCreated
  MigrationStart
  MigrationComplete
  MigrationFailed
  DocumentUpload
  DocumentView
  MigrationEntityImported
}

model AuditLog {
  id          String      @id @default(cuid())
  clinicId    String
  userId      String?
  action      AuditAction
  entityType  String?     // Chart, Photo, Patient, etc.
  entityId    String?
  details     String?     // JSON with additional context
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  // Relations
  clinic Clinic @relation(fields: [clinicId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])

  @@index([clinicId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ===========================================
// PATIENT COMMUNICATION
// ===========================================

enum ConsentSource {
  FrontDesk
  Portal
  Imported
  Other
}

enum MessageDirection {
  Outbound
  Inbound
}

enum MessageChannel {
  SMS
  MMS
}

enum MessagePurpose {
  AppointmentConfirmation
  Reminder
  Arrival
  FollowUp
  Generic
}

enum SmsVendor {
  Twilio
}

enum MessageStatus {
  Queued
  Sent
  Delivered
  Failed
  Canceled
}

enum ConversationType {
  Patient
}

model PatientCommunicationPreference {
  id            String        @id @default(cuid())
  clinicId      String
  patientId     String        @unique
  phoneE164     String?
  smsOptIn      Boolean       @default(false)
  smsOptInAt    DateTime?
  smsOptOutAt   DateTime?
  consentSource ConsentSource @default(FrontDesk)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  clinic  Clinic  @relation(fields: [clinicId], references: [id])
  patient Patient @relation(fields: [patientId], references: [id])

  @@unique([clinicId, patientId])
  @@index([clinicId])
  @@index([patientId])
}

model Conversation {
  id                 String           @id @default(cuid())
  clinicId           String
  type               ConversationType @default(Patient)
  patientId          String           @unique
  lastMessageAt      DateTime?
  lastMessagePreview String?
  unreadCount        Int              @default(0)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Relations
  clinic   Clinic    @relation(fields: [clinicId], references: [id])
  patient  Patient   @relation(fields: [patientId], references: [id])
  messages Message[]

  @@unique([clinicId, patientId])
  @@index([clinicId])
  @@index([patientId])
  @@index([lastMessageAt])
}

model Message {
  id               String           @id @default(cuid())
  clinicId         String
  conversationId   String
  direction        MessageDirection
  channel          MessageChannel   @default(SMS)
  purpose          MessagePurpose   @default(Generic)
  patientId        String
  appointmentId    String?
  bodyTextSnapshot String
  bodyHash         String
  mediaUrls        String?          // JSON array of URLs
  vendor           SmsVendor?
  vendorMessageId  String?
  status           MessageStatus    @default(Queued)
  errorCode        String?
  errorMessage     String?
  createdByUserId  String?
  sentAt           DateTime?
  deliveredAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id])
  patient      Patient      @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([conversationId])
  @@index([patientId])
  @@index([appointmentId])
  @@index([status])
  @@index([createdAt])
}

model MessageTemplate {
  id        String         @id @default(cuid())
  clinicId  String
  key       String
  purpose   MessagePurpose @default(Generic)
  bodyText  String
  isActive  Boolean        @default(true)
  version   Int            @default(1)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  // Relations
  clinic Clinic @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, key])
  @@index([clinicId])
}

// ===========================================
// NOTIFICATION TEMPLATES
// ===========================================

enum NotificationTrigger {
  PreAppointment
  PostAppointment
}

enum TimingUnit {
  Minutes
  Hours
  Days
}

model NotificationTemplate {
  id            String              @id @default(cuid())
  clinicId      String
  key           String?
  name          String
  description   String?
  trigger       NotificationTrigger
  offsetValue   Int
  offsetUnit    TimingUnit
  bodyText      String
  bodyHtml      String?
  emailEnabled  Boolean             @default(false)
  textEnabled   Boolean             @default(false)
  isActive      Boolean             @default(true)
  isSystem      Boolean             @default(false)
  systemKey     String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, key])
  @@index([clinicId])
  @@index([clinicId, systemKey])
}

// ===========================================
// FEATURE FLAGS
// ===========================================

model ClinicFeatureOverride {
  id        String   @id @default(cuid())
  clinicId  String
  feature   String
  enabled   Boolean
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, feature])
  @@index([clinicId])
}

// ===========================================
// DATA MIGRATION
// ===========================================

enum MigrationSource {
  Boulevard
  AestheticsRecord
  CsvUpload
}

enum MigrationJobStatus {
  Connecting
  Connected
  Discovering
  Discovered
  MappingInProgress
  MappingReview
  Migrating
  Paused
  Verifying
  Completed
  Failed
}

enum MigrationEntityType {
  Patient
  Service
  Appointment
  Chart
  Photo
  Invoice
  Consent
  Membership
  Document
  Form
}

model MigrationJob {
  id                   String             @id @default(cuid())
  clinicId             String
  source               MigrationSource
  status               MigrationJobStatus @default(Connecting)
  credentialsEncrypted String?
  connectionValidatedAt DateTime?

  // Authorization consent
  consentText          String?
  consentSignedAt      DateTime?
  consentSignedById    String?
  consentIpAddress     String?

  // AI agent data (JSON strings)
  sourceDiscovery      String?
  mappingConfig        String?
  pendingDecisions     String?
  progress             String   @default("{}")
  lastCheckpoint       String?
  agentLog             String?

  // Lifecycle
  startedById          String?
  startedAt            DateTime?
  completedAt          DateTime?
  errorMessage         String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  clinic     Clinic              @relation(fields: [clinicId], references: [id])
  logs       MigrationLog[]
  entityMaps MigrationEntityMap[]

  @@index([clinicId])
  @@index([status])
}

model MigrationLog {
  id           String              @id @default(cuid())
  jobId        String
  entityType   MigrationEntityType
  sourceId     String
  targetId     String?
  status       String              // imported, skipped, failed, duplicate, merged
  aiReasoning  String?
  errorMessage String?
  rawData      String?
  createdAt    DateTime            @default(now())

  job MigrationJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([jobId, entityType])
  @@index([sourceId])
}

model MigrationEntityMap {
  id         String              @id @default(cuid())
  jobId      String
  entityType MigrationEntityType
  sourceId   String
  targetId   String
  createdAt  DateTime            @default(now())

  job MigrationJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, entityType, sourceId])
  @@index([jobId])
}

// ===========================================
// MIGRATION V2 — Production Pipeline
// ===========================================

enum MigrationRunStatus {
  Created
  Ingesting
  Ingested
  Profiling
  Profiled
  DraftingMapping
  MappingDrafted
  MappingApproved
  Transforming
  Transformed
  Validating
  Validated
  Loading
  Loaded
  Reconciling
  Completed
  Failed
  Paused
}

model MigrationRun {
  id                  String             @id @default(cuid())
  clinicId            String
  sourceVendor        String             // "boulevard", "csv", "generic", etc.
  status              MigrationRunStatus @default(Created)
  currentPhase        String?            // "ingest", "profile", "draft_mapping", etc.

  // Artifacts & hashes
  artifactManifest    String?            // JSON: list of ArtifactRefs with hashes

  // Non-PHI analysis results
  sourceProfile       String?            // JSON: SourceProfile
  phiClassification   String?            // JSON: field → isPHI overrides

  // Mapping
  mappingSpecVersion  Int                @default(0)
  mappingApprovedAt   DateTime?
  mappingApprovedById String?

  // Progress & resume
  progress            String             @default("{}")
  lastCheckpoint      String?

  // Consent & lifecycle
  consentText         String?
  consentSignedAt     DateTime?
  startedById         String?
  startedAt           DateTime?
  completedAt         DateTime?
  errorMessage        String?

  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Relations
  clinic              Clinic             @relation(fields: [clinicId], references: [id])
  artifacts           MigrationArtifact[]
  mappingSpecs        MigrationMappingSpec[]
  ledgerEntries       MigrationRecordLedger[]
  auditEvents         MigrationAuditEvent[]
  stagingRecords      CanonicalStagingRecord[]

  @@index([clinicId])
  @@index([status])
}

model MigrationArtifact {
  id        String   @id @default(cuid())
  runId     String
  key       String   // filename or entity name
  hash      String   // SHA-256
  sizeBytes Int
  storedAt  String   // local path or S3 URI
  metadata  String?  // JSON
  createdAt DateTime @default(now())

  run MigrationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, key])
  @@index([runId])
}

model MigrationMappingSpec {
  id        String   @id @default(cuid())
  runId     String
  version   Int
  spec      String   // JSON: MappingSpec
  createdAt DateTime @default(now())

  run MigrationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, version])
  @@index([runId])
}

model MigrationRecordLedger {
  id                String   @id @default(cuid())
  runId             String
  entityType        String
  sourceRecordId    String
  canonicalId       String
  status            String   // "staged", "validated", "loaded", "promoted", "failed"
  sourceChecksum    String
  canonicalChecksum String?
  errorCode         String?  // non-PHI error code
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  run MigrationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, entityType, sourceRecordId])
  @@index([runId, status])
}

model MigrationAuditEvent {
  id        String   @id @default(cuid())
  runId     String
  phase     String   // "ingest", "profile", etc.
  action    String   // "MAPPING_APPROVED", "VALIDATION_FAILED", etc.
  actorId   String?  // user ID or "system"
  metadata  String?  // JSON: non-PHI metadata only
  createdAt DateTime @default(now())

  run MigrationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
}

model CanonicalStagingRecord {
  id          String   @id @default(cuid())
  runId       String
  entityType  String
  canonicalId String
  payload     String   // JSON: canonical record
  checksum    String
  status      String   @default("staged") // "staged", "validated", "promoted"
  createdAt   DateTime @default(now())

  run MigrationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, entityType, canonicalId])
  @@index([runId, status])
}
