// Prisma schema for MedSpa EMR
// SQLite for local dev, Postgres-compatible schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ===========================================
// MULTI-TENANCY
// ===========================================

model Clinic {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  address   String?
  phone     String?
  email     String?
  timezone  String   @default("America/New_York")
  logoUrl   String?
  locationName String?
  externalId   String?
  addressLine2 String?
  city         String?
  state        String?
  zipCode      String?
  country      String   @default("US")
  website      String?
  locationHours    String?  // JSON: { mon: { enabled, start, end }, ... }
  socialAccounts   String?  // JSON: { yelp, facebook, instagram, ... }
  calendarSettings String?  // JSON: { timeInterval, startTime, endTime, colorUsage, firstDayOfWeek }
  defaultTaxRate   Float?   // Default tax rate percentage for invoices
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users             User[]
  patients          Patient[]
  services          Service[]
  appointments      Appointment[]
  charts            Chart[]
  photos            Photo[]
  consents          ConsentTemplate[]
  patientConsents   PatientConsent[]
  invoices          Invoice[]
  invoiceItems      InvoiceItem[]
  payments          Payment[]
  memberships          MembershipPlan[]
  patientMemberships   PatientMembership[]
  auditLogs         AuditLog[]
  rooms             Room[]
  resources         Resource[]
  chartTemplates    ChartTemplate[]
  products          Product[]
  communicationPreferences PatientCommunicationPreference[]
  conversations     Conversation[]
  messageTemplates  MessageTemplate[]
  notificationTemplates NotificationTemplate[]
}

// ===========================================
// USERS & ROLES
// ===========================================

enum Role {
  Owner
  Admin
  Provider
  FrontDesk
  Billing
  MedicalDirector
  ReadOnly
}

model User {
  id            String    @id @default(cuid())
  clinicId      String
  email         String    @unique
  name          String
  passwordHash    String?
  emailVerified   DateTime?
  role            Role      @default(Provider)
  isActive        Boolean   @default(true)
  phone           String?
  alias           String?
  pronouns        String?
  profileImageUrl String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  clinic               Clinic              @relation(fields: [clinicId], references: [id])
  appointments         Appointment[]       @relation("AppointmentProvider")
  charts               Chart[]             @relation("ChartCreator")
  signedCharts         Chart[]             @relation("ChartSigner")
  auditLogs            AuditLog[]
  photosTaken          Photo[]

  @@index([clinicId])
  @@index([email])
}

// ===========================================
// PATIENTS & CRM
// ===========================================

model Patient {
  id            String    @id @default(cuid())
  clinicId      String
  firstName     String
  lastName      String
  email         String?
  phone         String?
  dateOfBirth   DateTime?
  gender        String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  allergies     String?   // Stored as text, can be JSON in practice
  medicalNotes  String?
  tags          String?   // Comma-separated or JSON array
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  // Relations
  clinic           Clinic            @relation(fields: [clinicId], references: [id])
  appointments     Appointment[]
  charts           Chart[]
  photos           Photo[]
  consents         PatientConsent[]
  invoices         Invoice[]
  patientMemberships PatientMembership[]
  communicationPreference PatientCommunicationPreference?
  conversation     Conversation?
  messages         Message[]

  @@index([clinicId])
  @@index([lastName, firstName])
  @@index([email])
  @@index([phone])
}

// ===========================================
// SCHEDULING
// ===========================================

model Room {
  id            String   @id @default(cuid())
  clinicId      String
  name          String
  description   String?
  category      String?
  color         String?
  capacity      String   @default("one")
  maxConcurrent Int      @default(1)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  clinic       Clinic        @relation(fields: [clinicId], references: [id])
  appointments Appointment[]

  @@index([clinicId])
}

model Resource {
  id            String   @id @default(cuid())
  clinicId      String
  name          String
  description   String?
  category      String?
  color         String?
  capacity      String   @default("one")
  maxConcurrent Int      @default(1)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  clinic       Clinic        @relation(fields: [clinicId], references: [id])
  appointments Appointment[]

  @@index([clinicId])
}

enum AppointmentStatus {
  Scheduled
  Confirmed
  CheckedIn
  InProgress
  Completed
  NoShow
  Cancelled
}

model Appointment {
  id          String            @id @default(cuid())
  clinicId    String
  patientId   String
  providerId  String
  serviceId   String?
  roomId      String?
  resourceId  String?
  startTime   DateTime
  endTime     DateTime
  status      AppointmentStatus @default(Scheduled)
  notes       String?
  checkedInAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  checkedOutAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?         // Soft delete

  // Relations
  clinic   Clinic   @relation(fields: [clinicId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])
  provider User     @relation("AppointmentProvider", fields: [providerId], references: [id])
  service  Service? @relation(fields: [serviceId], references: [id])
  room     Room?     @relation(fields: [roomId], references: [id])
  resource Resource? @relation(fields: [resourceId], references: [id])
  chart    Chart?
  invoice  Invoice?

  @@index([clinicId])
  @@index([patientId])
  @@index([providerId])
  @@index([startTime])
}

// ===========================================
// SERVICES
// ===========================================

model Service {
  id          String   @id @default(cuid())
  clinicId    String
  name        String
  description String?
  duration    Int      @default(30) // in minutes
  price       Float    @default(0)
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  clinic              Clinic                  @relation(fields: [clinicId], references: [id])
  appointments        Appointment[]
  invoiceItems        InvoiceItem[]
  serviceTemplates    ServiceTemplate[]

  @@index([clinicId])
}

model ServiceTemplate {
  id         String @id @default(cuid())
  serviceId  String
  templateId String

  service  Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  template ChartTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([serviceId, templateId])
  @@index([serviceId])
  @@index([templateId])
}

model Product {
  id             String   @id @default(cuid())
  clinicId       String
  name           String
  description    String?
  size           String?
  sku            String?
  upc            String?
  category       String?
  retailPrice    Float    @default(0)
  wholesaleCost  Float    @default(0)
  vendor         String?
  inventoryCount Int      @default(0)
  taxable        Boolean  @default(true)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  clinic       Clinic        @relation(fields: [clinicId], references: [id])
  invoiceItems InvoiceItem[]

  @@index([clinicId])
}

// ===========================================
// CLINICAL CHARTING
// ===========================================

enum ChartStatus {
  Draft
  NeedsSignOff
  MDSigned
}

model ChartTemplate {
  id           String   @id @default(cuid())
  clinicId     String
  type         String   @default("chart") // "chart" or "form"
  name         String
  description  String?
  category     String?
  fieldsConfig String   // JSON array of field definitions
  status       String   @default("Active") // Active, Draft, Archived
  isSystem     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  clinic           Clinic            @relation(fields: [clinicId], references: [id])
  charts           Chart[]
  serviceTemplates ServiceTemplate[]
  @@index([clinicId])
}

model Chart {
  id              String      @id @default(cuid())
  clinicId        String
  patientId       String
  appointmentId   String?     @unique
  templateId      String?
  createdById     String
  status          ChartStatus @default(Draft)

  // Treatment details
  chiefComplaint  String?
  areasTreated   String?     // JSON array of areas
  productsUsed    String?     // JSON array of products with lot/expiration
  dosageUnits     String?
  technique       String?
  aftercareNotes  String?
  additionalNotes String?

  // Medical Director sign-off metadata
  signedById      String?
  signedByName    String?
  signedAt        DateTime?
  recordHash      String?     // Immutable hash for integrity verification

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?   // Soft delete

  // Relations
  clinic      Clinic         @relation(fields: [clinicId], references: [id])
  patient     Patient        @relation(fields: [patientId], references: [id])
  appointment Appointment?   @relation(fields: [appointmentId], references: [id])
  template    ChartTemplate? @relation(fields: [templateId], references: [id])
  createdBy   User           @relation("ChartCreator", fields: [createdById], references: [id])
  signedBy    User?          @relation("ChartSigner", fields: [signedById], references: [id])
  photos      Photo[]

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
  @@index([createdById])
}

// ===========================================
// CLINICAL PHOTOS
// ===========================================

model Photo {
  id           String   @id @default(cuid())
  clinicId     String
  patientId    String
  chartId      String?
  takenById    String
  filename     String
  storagePath  String   // Path in storage system
  mimeType     String
  sizeBytes    Int
  category     String?  // before, after, progress, etc.
  annotations  String?  // JSON: vector overlays, points, lines
  caption      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime? // Soft delete

  // Relations
  clinic   Clinic  @relation(fields: [clinicId], references: [id])
  patient  Patient @relation(fields: [patientId], references: [id])
  chart    Chart?  @relation(fields: [chartId], references: [id])
  takenBy  User    @relation(fields: [takenById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([chartId])
}

// ===========================================
// CONSENTS
// ===========================================

model ConsentTemplate {
  id        String    @id @default(cuid())
  clinicId  String
  name      String
  content   String    // HTML or Markdown content
  version   String    @default("1.0")
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  clinic          Clinic           @relation(fields: [clinicId], references: [id])
  patientConsents PatientConsent[]

  @@index([clinicId])
}

model PatientConsent {
  id                String    @id @default(cuid())
  clinicId          String
  patientId         String
  templateId        String
  signatureData     String?   // Base64 or JSON signature data
  signedAt          DateTime?
  ipAddress         String?
  userAgent         String?
  templateSnapshot  String?   // Snapshot of template content at signing time
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? // Soft delete

  // Relations
  clinic   Clinic          @relation(fields: [clinicId], references: [id])
  patient  Patient         @relation(fields: [patientId], references: [id])
  template ConsentTemplate @relation(fields: [templateId], references: [id])

  @@index([clinicId])
  @@index([patientId])
}

// ===========================================
// BILLING
// ===========================================

enum InvoiceStatus {
  Draft
  Sent
  PartiallyPaid
  Paid
  Void
  Refunded
}

model Invoice {
  id            String        @id @default(cuid())
  clinicId      String
  patientId     String
  appointmentId String?       @unique
  invoiceNumber String
  status        InvoiceStatus @default(Draft)
  subtotal      Float         @default(0)
  discountAmount Float        @default(0)
  discountPercent Float?
  taxAmount     Float         @default(0)
  taxRate       Float?
  total         Float         @default(0)
  notes         String?
  dueDate       DateTime?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  // Relations
  clinic      Clinic       @relation(fields: [clinicId], references: [id])
  patient     Patient      @relation(fields: [patientId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  items       InvoiceItem[]
  payments    Payment[]

  @@unique([clinicId, invoiceNumber])
  @@index([clinicId])
  @@index([patientId])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  clinicId    String
  invoiceId   String
  serviceId   String?
  productId   String?
  description String
  quantity    Int     @default(1)
  unitPrice   Float
  total       Float
  deletedAt   DateTime?

  // Relations
  clinic  Clinic   @relation(fields: [clinicId], references: [id])
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id])
  product Product? @relation(fields: [productId], references: [id])

  @@index([clinicId])
  @@index([invoiceId])
}

model Payment {
  id            String   @id @default(cuid())
  clinicId      String
  invoiceId     String
  amount        Float
  paymentMethod String   // cash, credit, debit, etc.
  reference     String?  // External reference number
  notes         String?
  createdAt     DateTime @default(now())
  deletedAt     DateTime?

  // Relations
  clinic  Clinic  @relation(fields: [clinicId], references: [id])
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([invoiceId])
}

// ===========================================
// MEMBERSHIPS & PACKAGES
// ===========================================

model MembershipPlan {
  id            String   @id @default(cuid())
  clinicId      String
  name          String
  description   String?
  price         Float    // Dollar amount charged per cycle
  billingCycle  String   @default("Monthly") // Always Monthly
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  clinic             Clinic                  @relation(fields: [clinicId], references: [id])
  patientMemberships PatientMembership[]

  @@index([clinicId])
}


model PatientMembership {
  id        String   @id @default(cuid())
  clinicId  String
  patientId String
  planId    String
  status    String   @default("Active") // Active, Paused, Cancelled
  startDate DateTime @default(now())
  termMonths   Int      @default(12)
  nextBillDate DateTime?
  cancelledAt  DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clinic  Clinic         @relation(fields: [clinicId], references: [id])
  patient Patient        @relation(fields: [patientId], references: [id])
  plan    MembershipPlan @relation(fields: [planId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
}

// ===========================================
// AUDIT LOGGING
// ===========================================

enum AuditAction {
  ChartView
  ChartCreate
  ChartUpdate
  ChartSign
  PhotoView
  PhotoUpload
  PhotoAnnotationUpdate
  PhotoDelete
  ConsentView
  ConsentSign
  PatientView
  PatientCreate
  PatientUpdate
  InvoiceView
  InvoiceCreate
  InvoiceUpdate
  InvoiceDelete
  PaymentCreate
  Login
  Logout
  AppointmentConfirm
  AppointmentCheckIn
  AppointmentStart
  AppointmentComplete
  AppointmentCheckOut
  AppointmentUndoCheckIn
  AppointmentUndoStart
  AppointmentUndoComplete
  MessageSend
  MessageFailed
  ConversationView
  AiChat
}

model AuditLog {
  id          String      @id @default(cuid())
  clinicId    String
  userId      String?
  action      AuditAction
  entityType  String?     // Chart, Photo, Patient, etc.
  entityId    String?
  details     String?     // JSON with additional context
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  // Relations
  clinic Clinic @relation(fields: [clinicId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])

  @@index([clinicId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ===========================================
// PATIENT COMMUNICATION
// ===========================================

enum ConsentSource {
  FrontDesk
  Portal
  Imported
  Other
}

enum MessageDirection {
  Outbound
  Inbound
}

enum MessageChannel {
  SMS
  MMS
}

enum MessagePurpose {
  AppointmentConfirmation
  Reminder
  Arrival
  FollowUp
  Generic
}

enum SmsVendor {
  Twilio
}

enum MessageStatus {
  Queued
  Sent
  Delivered
  Failed
  Canceled
}

enum ConversationType {
  Patient
}

model PatientCommunicationPreference {
  id            String        @id @default(cuid())
  clinicId      String
  patientId     String        @unique
  phoneE164     String?
  smsOptIn      Boolean       @default(false)
  smsOptInAt    DateTime?
  smsOptOutAt   DateTime?
  consentSource ConsentSource @default(FrontDesk)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  clinic  Clinic  @relation(fields: [clinicId], references: [id])
  patient Patient @relation(fields: [patientId], references: [id])

  @@unique([clinicId, patientId])
  @@index([clinicId])
  @@index([patientId])
}

model Conversation {
  id                 String           @id @default(cuid())
  clinicId           String
  type               ConversationType @default(Patient)
  patientId          String           @unique
  lastMessageAt      DateTime?
  lastMessagePreview String?
  unreadCount        Int              @default(0)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Relations
  clinic   Clinic    @relation(fields: [clinicId], references: [id])
  patient  Patient   @relation(fields: [patientId], references: [id])
  messages Message[]

  @@unique([clinicId, patientId])
  @@index([clinicId])
  @@index([patientId])
  @@index([lastMessageAt])
}

model Message {
  id               String           @id @default(cuid())
  clinicId         String
  conversationId   String
  direction        MessageDirection
  channel          MessageChannel   @default(SMS)
  purpose          MessagePurpose   @default(Generic)
  patientId        String
  appointmentId    String?
  bodyTextSnapshot String
  bodyHash         String
  mediaUrls        String?          // JSON array of URLs
  vendor           SmsVendor?
  vendorMessageId  String?
  status           MessageStatus    @default(Queued)
  errorCode        String?
  errorMessage     String?
  createdByUserId  String?
  sentAt           DateTime?
  deliveredAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id])
  patient      Patient      @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([conversationId])
  @@index([patientId])
  @@index([appointmentId])
  @@index([status])
  @@index([createdAt])
}

model MessageTemplate {
  id        String         @id @default(cuid())
  clinicId  String
  key       String
  purpose   MessagePurpose @default(Generic)
  bodyText  String
  isActive  Boolean        @default(true)
  version   Int            @default(1)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  // Relations
  clinic Clinic @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, key])
  @@index([clinicId])
}

// ===========================================
// NOTIFICATION TEMPLATES
// ===========================================

enum NotificationTrigger {
  PreAppointment
  PostAppointment
}

enum TimingUnit {
  Minutes
  Hours
  Days
}

model NotificationTemplate {
  id            String              @id @default(cuid())
  clinicId      String
  key           String?
  name          String
  description   String?
  trigger       NotificationTrigger
  offsetValue   Int
  offsetUnit    TimingUnit
  bodyText      String
  bodyHtml      String?
  emailEnabled  Boolean             @default(false)
  textEnabled   Boolean             @default(false)
  isActive      Boolean             @default(true)
  isSystem      Boolean             @default(false)
  systemKey     String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, key])
  @@index([clinicId])
  @@index([clinicId, systemKey])
}
